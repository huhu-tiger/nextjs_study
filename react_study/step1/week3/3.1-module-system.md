# 3.1 模块系统和声明文件

## 学习目标
- 掌握ES Modules和CommonJS的使用
- 理解模块声明和命名空间
- 熟练编写声明文件(.d.ts)
- 了解第三方库类型定义
- 掌握类型导入和导出

## 学习内容

### 1. ES Modules和CommonJS

#### 1.1 ES Modules基础
```typescript
// 基础导出
export const name = "TypeScript";
export const version = "5.0";

// 命名导出
export function greet(name: string): string {
  return `Hello, ${name}!`;
}

export class User {
  constructor(public name: string, public email: string) {}
}

// 默认导出
export default class ApiClient {
  constructor(private baseUrl: string) {}
  
  async get<T>(endpoint: string): Promise<T> {
    // 实现
  }
}

// 重新导出
export { greet as sayHello } from './greetings';
export * from './types';
```

#### 1.2 ES Modules导入
```typescript
// 命名导入
import { greet, User } from './utils';
import { name, version } from './constants';

// 默认导入
import ApiClient from './ApiClient';

// 命名空间导入
import * as utils from './utils';

// 混合导入
import ApiClient, { greet, User } from './api';

// 类型导入
import type { User, ApiResponse } from './types';
import type { ComponentProps } from 'react';

// 重新导出
export { greet } from './utils';
export type { User } from './types';
```

#### 1.3 CommonJS互操作
```typescript
// CommonJS模块声明
declare module 'legacy-module' {
  function legacyFunction(param: string): number;
  const legacyConstant: boolean;
  export = { legacyFunction, legacyConstant };
}

// 使用CommonJS模块
import legacy = require('legacy-module');
const result = legacy.legacyFunction('test');

// 或者使用ES模块语法
import * as legacy from 'legacy-module';
const result = legacy.legacyFunction('test');
```

### 2. 模块声明和命名空间

#### 2.1 模块声明
```typescript
// 声明模块
declare module 'custom-module' {
  export interface CustomConfig {
    apiUrl: string;
    timeout: number;
  }
  
  export function initialize(config: CustomConfig): void;
  export function getData<T>(endpoint: string): Promise<T>;
}

// 使用声明的模块
import { initialize, getData, CustomConfig } from 'custom-module';

const config: CustomConfig = {
  apiUrl: 'https://api.example.com',
  timeout: 5000
};

initialize(config);
```

#### 2.2 命名空间
```typescript
// 命名空间定义
namespace MyLibrary {
  export interface Config {
    apiUrl: string;
    timeout: number;
  }
  
  export class ApiClient {
    constructor(private config: Config) {}
    
    async get<T>(endpoint: string): Promise<T> {
      // 实现
    }
  }
  
  export namespace Utils {
    export function formatDate(date: Date): string {
      return date.toISOString();
    }
    
    export function validateEmail(email: string): boolean {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }
  }
}

// 使用命名空间
const client = new MyLibrary.ApiClient({
  apiUrl: 'https://api.example.com',
  timeout: 5000
});

const formattedDate = MyLibrary.Utils.formatDate(new Date());
```

#### 2.3 模块扩展
```typescript
// 扩展现有模块
declare module 'express' {
  interface Request {
    user?: {
      id: number;
      name: string;
      email: string;
    };
  }
}

// 扩展全局对象
declare global {
  interface Window {
    myCustomProperty: string;
  }
  
  namespace NodeJS {
    interface ProcessEnv {
      NODE_ENV: 'development' | 'production' | 'test';
      API_URL: string;
      DATABASE_URL: string;
    }
  }
}
```

### 3. 声明文件编写

#### 3.1 基础声明文件
```typescript
// types/global.d.ts
declare global {
  interface Window {
    gtag: (command: string, targetId: string, config?: any) => void;
  }
}

// types/api.d.ts
export interface ApiResponse<T> {
  data: T;
  status: number;
  message: string;
}

export interface User {
  id: number;
  name: string;
  email: string;
  createdAt: Date;
}

export interface CreateUserRequest {
  name: string;
  email: string;
  password: string;
}

// types/events.d.ts
export interface CustomEvent<T = any> {
  type: string;
  payload: T;
  timestamp: number;
}

export type EventHandler<T = any> = (event: CustomEvent<T>) => void;
```

#### 3.2 第三方库声明文件
```typescript
// types/third-party.d.ts
declare module 'lodash' {
  export function debounce<T extends (...args: any[]) => any>(
    func: T,
    wait: number
  ): T;
  
  export function throttle<T extends (...args: any[]) => any>(
    func: T,
    wait: number
  ): T;
  
  export function pick<T, K extends keyof T>(
    object: T,
    ...paths: K[]
  ): Pick<T, K>;
}

// 使用声明的第三方库
import { debounce, throttle, pick } from 'lodash';

const debouncedFn = debounce((value: string) => {
  console.log(value);
}, 300);

const throttledFn = throttle((value: string) => {
  console.log(value);
}, 1000);
```

#### 3.3 复杂声明文件
```typescript
// types/complex.d.ts
declare module 'complex-library' {
  // 基础接口
  export interface Config {
    apiUrl: string;
    timeout: number;
    retries: number;
  }
  
  // 泛型接口
  export interface Repository<T> {
    findById(id: number): Promise<T | null>;
    save(entity: T): Promise<T>;
    delete(id: number): Promise<boolean>;
  }
  
  // 类声明
  export class ApiClient {
    constructor(config: Config);
    get<T>(endpoint: string): Promise<T>;
    post<T>(endpoint: string, data: any): Promise<T>;
  }
  
  // 函数重载
  export function process(data: string): string;
  export function process(data: number): number;
  export function process(data: boolean): boolean;
  
  // 命名空间
  export namespace Utils {
    function formatDate(date: Date): string;
    function validateEmail(email: string): boolean;
  }
  
  // 默认导出
  export default class ComplexLibrary {
    constructor(config: Config);
    // 方法定义
  }
}
```

### 4. 类型导入和导出

#### 4.1 类型导入
```typescript
// 基础类型导入
import type { User, ApiResponse } from './types';
import type { ComponentProps } from 'react';

// 类型导入和值导入混合
import { ApiClient, type ApiConfig } from './api';
import { type User, createUser } from './user';

// 类型导入重命名
import type { User as UserType } from './types';
import type { ApiResponse as ResponseType } from './api';

// 类型导入命名空间
import type * as Types from './types';
import type * as ApiTypes from './api';
```

#### 4.2 类型导出
```typescript
// 基础类型导出
export type { User, ApiResponse } from './types';
export type { ComponentProps } from 'react';

// 类型导出重命名
export type { User as UserType } from './types';
export type { ApiResponse as ResponseType } from './api';

// 类型导出命名空间
export type * as Types from './types';
export type * as ApiTypes from './api';

// 条件类型导出
export type { User } from './types';
export type { ApiResponse } from './api';
```

#### 4.3 类型导入导出最佳实践
```typescript
// types/index.ts - 统一类型导出
export type { User, CreateUserRequest, UpdateUserRequest } from './user';
export type { ApiResponse, ApiError, PaginatedResponse } from './api';
export type { EventHandler, CustomEvent } from './events';

// 使用统一类型导出
import type { User, ApiResponse, EventHandler } from './types';

// 避免类型和值混合导入
// 不推荐
import { User, type ApiResponse } from './types';

// 推荐
import type { User, ApiResponse } from './types';
import { createUser, updateUser } from './user';
```

### 5. 模块解析和配置

#### 5.1 tsconfig.json配置
```json
{
  "compilerOptions": {
    "moduleResolution": "node",
    "baseUrl": "./",
    "paths": {
      "@/*": ["src/*"],
      "@/types/*": ["src/types/*"],
      "@/utils/*": ["src/utils/*"],
      "@/services/*": ["src/services/*"]
    },
    "typeRoots": ["./node_modules/@types", "./types"],
    "types": ["node", "jest", "express"]
  }
}
```

#### 5.2 路径映射
```typescript
// 使用路径映射
import { User } from '@/types/user';
import { ApiClient } from '@/services/api';
import { formatDate } from '@/utils/date';

// 相对路径
import { User } from '../types/user';
import { ApiClient } from '../services/api';
import { formatDate } from '../utils/date';
```

#### 5.3 模块解析策略
```typescript
// 模块解析优先级
// 1. 相对路径
import { User } from './user';

// 2. 绝对路径
import { User } from '/src/types/user';

// 3. 路径映射
import { User } from '@/types/user';

// 4. node_modules
import { User } from 'my-package';

// 5. 类型声明
import { User } from 'types/user';
```

## 实践练习

### 练习1：模块声明
```typescript
// 任务：为第三方库创建声明文件
// 假设有一个名为 'my-awesome-lib' 的库

// 1. 创建基础声明文件
declare module 'my-awesome-lib' {
  // 你的实现
}

// 2. 创建复杂类型声明
declare module 'my-awesome-lib' {
  // 你的实现
}

// 3. 创建命名空间声明
declare module 'my-awesome-lib' {
  // 你的实现
}
```

### 练习2：类型导入导出
```typescript
// 任务：创建类型导入导出系统

// 1. 创建类型定义文件
// types/user.d.ts
export interface User {
  // 你的实现
}

// 2. 创建类型导出文件
// types/index.d.ts
export type { /* 你的实现 */ };

// 3. 创建类型导入文件
// src/app.ts
import type { /* 你的实现 */ };
```

### 练习3：模块扩展
```typescript
// 任务：扩展现有模块

// 1. 扩展Express模块
declare module 'express' {
  // 你的实现
}

// 2. 扩展全局对象
declare global {
  // 你的实现
}

// 3. 扩展第三方库
declare module 'lodash' {
  // 你的实现
}
```

## 学习检查点

- [ ] 能够使用ES Modules和CommonJS
- [ ] 理解模块声明和命名空间
- [ ] 熟练编写声明文件
- [ ] 了解第三方库类型定义
- [ ] 掌握类型导入和导出

## 下一步学习

完成本部分学习后，请继续学习 [3.2 现代JavaScript特性](./3.2-modern-js.md)。
